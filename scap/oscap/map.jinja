{%- from 'scap/map.jinja' import scap with context %}

{%- set osrel = salt.grains.get('osmajorrelease') %}

{%- set os = salt.grains.filter_by({
    'RedHat': 'rhel',
    'CentOS': 'centos'
}, grain='os') %}

{#- Initialize oscap dictionary with defaults and pillar data #}
{%- set oscap = salt.pillar.get(
    'scap:lookup:oscap',
    default = {
        'cpe': 'ssg/ssg-rhel' ~ osrel ~ '-cpe-dictionary.xml',
        'xccdf': 'ssg/ssg-' ~ os ~ osrel ~ '-xccdf.xml',
        'profile': 'common',
        'outputdir': '/root/scap/output'
    },
    merge = True
) %}

{#- Update oscap dictionary with static values #}
{%- do oscap.update({
    'cpe': scap.content.local_dir ~ '/' ~ oscap.cpe,
    'xccdf': scap.content.local_dir ~ '/' ~ oscap.xccdf,
    'report': oscap.outputdir ~ '/oscap-report.' ~ oscap.xccdf|replace('/','.') ~ '.$(date "+%Y%m%d%H%M").html',
    'results': oscap.outputdir ~ '/oscap-results.' ~ oscap.xccdf|replace('/','.') ~ '.$(date "+%Y%m%d%H%M").xml'
}) %}
